{% extends "base.html" %}
{% import "macros.html" as macro %}

{% block login %}
    {% if user: %}
        {{ macro.top_welcome(user) }}
    {% else: %}
        {{ macro.top_login() }}
    {% endif %}
{% endblock %}
{% block script_src%}
    <script src="/static/js/custom/book_info.js"></script>
{% endblock%}

{% block content %}
    {% if msg: %}
    {{ msg }}
    {% endif %}
    <div class="span12">
    	<div style=";margin-top:10px;height:180px;width:920px;" class="row">
            <div class="result-image pull-left" >
            {% if book.images.get(): %}
                <img src="/image/{{book.images.get().key().id()}}.{{book.images.get().ftype}}" class="info-img img-rounded" alt="{{book.title}}"/>
            {% else:%}
                <div class="result-img" ><div style="height:25px;"></div>
                <label class="label label-success" alt="no image available" title="No image available" style="text-align:center;"/>No image<br/>available</label></div>
            {% endif %}
            </div>
            <div class="span5" >
                {% if user.admin: %}{{ adminBookInfo() }}{% else:%}
                <h3><small>Book Information</small></h3>
                <table class="table table-bordered table-condensed">
                    <tr><td style="width:55px">Title</td><td>{{book.title}}</td></tr>
                    <tr><td>Author</td><td>{{book.author}}</td></tr>
                    <tr class="hidden" name="info"><td>ISBN</td><td>{%if book.isbn%}{{book.isbn}}{%else%}No Data{%endif%}</td></tr>
                    {% if book.description%}<tr class="hidden" name="info"><td></td><td>{{book.description}}</td></tr>{%endif%}
                    <tr class="hidden" name="info"></tr>
                </table>
                {% endif%}
            </div>
            <div class="span3">
                <div id="book-stats" style="display:none">
                    <h3><small>Book Statistics</small></h3>
                    <table class="table table-condensed">
                        <tr><td style="width:90px">Listed</td>
                            <td>{{stats["listed"]}}</td></tr>
                        <tr><td>Total Sold</td>
                            <td>{{stats["totalSold"]}}</td></tr>
                        <tr><td>Ave Price</td>
                            <td>{{stats["avePrice"]}}</td></tr>
                        <tr><td>New Price</td>
                            <td>{{stats["newPrice"]}}</td></tr>
                        <tr><td></td><td></td></tr>
                    </table>
                </div>
            </div>
            <div id="mini-nav" class="well span3 pull-right" style="padding:8px 0;width:160px;margin-top:25px;margin-right:20px">
                <ul class="nav nav-list">
                    <li><a style="margin-top:5px" href="javascript:void(0)" id="more-info" onclick="moreInfo()" class="">
                        <i class="icon-info-sign" id="icon-more-info"></i>More Info</a></li>
                    <li ><a href="javascript:void(0)" onclick="getStats()" id="show-stats-link"><i class="icon-list-alt" id="icon-show-stats"></i>Show stats</a></li>
                    <li><a href="/sell/step3?book={{book.key().id()}}"><i class="icon-book" id="icon-sell-book"></i>Sell your copy</a></li>
                    <li><a href="#how-to-buy" data-toggle="modal"><i class="icon-question-sign"></i>How to Buy?</a></li>
                </ul>
            </div>
        </div>
        <div class="row">
    	<div class="span7">
    		<h3>People Selling this book </h3>
            <div style="position:relative;" id="sorting-nav">
                <div style="margin-left:185px;position:absolute">
                    <h2><small>Sort by</small></h2>
                </div>
                <span class="hidden" id="loading" style="position:absolute;right:13px;top:7px">
                    <i class="request-loading"></i>
                </span><img title="Error in fetching listings" src="/static/images/error.gif" class="hidden" id="load-error" style="position:absolute;right:13px;top:7px;width:18px">
                <div class="offset3" >{# upper nav #}
                <ul class="nav nav-tabs">
                    <li id="li-sort-posted"><a href="javascript:void(0)" onclick="requestSellers('posted')">Date</a></li>
                    <li id="li-sort-rating"><a href="javascript:void(0)" onclick="requestSellers('rating')">Rating</a></li>
                    <li id="li-sort-price"><a href="javascript:void(0)" onclick="requestSellers('price')">Price</a></li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)"><b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li id="li-sort-asc"><a href="javascript:void(0)" onclick="reorder('asc')">Ascending</a></li>
                            <li id="li-sort-desc" ><a href="javascript:void(0)" onclick="reorder('desc')">Descending</a></li>    
                        </ul>
                </ul>
                </div>
            </div>
            <div style="width:360px;margin-left:90px" id="no-results" class="hidden">
                <h2><small>No one is selling this item as of the moment</small></h2>
                <a href="/book/request?book={{book.key().id()}}">Click here to request</a> a copy of this book
                <br/><a href="/sell/step3?book={{book.key().id()}}">Click here to sell</a> a copy of this book
            </div>
            <div style="display:table;" id="sellers-list">
            </div>
            <div id="results-nav">
                <div>
                    <center><h3><small id="display-info">Showing 0-0 of 0</small></h3></center>
                </div>
                <div class="pagination pagination-centered" >
                    <ul id="pagination">
                        <li><a href="javascript:void(0)">«</a></li>
                        <li class="active"><a href="javascript:void(0)">1</a></li>
                        <li><a href="javascript:void(0)">»</a></li>
                    </ul>
                </div>
            </div>
    	</div>
        {% if user.admin%}
        <div class="span well" style="width:160px;margin-left:180px;padding:8px 0 " id="admin-mini-nav">
            <ul class="nav nav-list">
                <li class="nav-header">Admin Nav</li>
                <li><a href="javascript:void(0)" id="" onclick="adminEditInfo()">
                    <i class="icon-pencil"></i>Edit Information</a></li>
                <li ><a href="javascript:void(0)" id="" onclick="">
                    <i class="icon-plus-sign" ></i>Add Consignee</a></li>
                <li ><a href="javascript:void(0)" id="" onclick="adminAddImage()">
                    <i class="icon-picture" ></i>Add Image</a></li>
                <li ><a href="javascript:void(0)" id="" onclick="">
                    <i class="icon-time" ></i>View History</a></li>
                <li ><a href="javascript:void(0)" id="" onclick="">
                    <i class="icon-remove-sign" ></i>Remove</a></li>
            </ul>
        </div>
        {% endif %}
        </div>
	</div>
    <div class="modal hide fade" id="how-to-buy">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">×</button>
            <h3>How to Buy</h3>
        </div>
        <div class="modal-body">
            
            
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Close</a>
        </div>
    </div>
    <div class="modal hide fade" id="modal-order-details">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">×</button>
            <h3>Sell Details</h3>
            <i class="request-loading" id="loading-details" style="display:none;margin:-22px 0 0 110px;float:left;"></i>
        </div>
        <div class="modal-body">
            <div id="order-details" class="span">
            </div>
            <div id="images-div" class="span">
            </div>
        </div>
        <div class="modal-footer">
            <a href="#">Report</a>
            <button type="button" class="btn btn-danger">Remove</button>
            <a href="#" class="btn" data-dismiss="modal">Close</a>
        </div>
    </div>
    {% if user.admin %}
    <div class="modal hide fade" id="admin-control">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">×</button>
            <h3>Admin Control</h3>
        </div>
        <div class="modal-body">
            <div id="addImage">
                <h3>Upload Image</h3>
                <form action="/admin" method="post" enctype="multipart/form-data">
                    <input type="file" name="img1" id="img-upload" onchange="adminAddImage(2)"/>
                    <br/><input type="submit" id="upload-img" value="Upload Image" name="upload-img" class="btn btn-success" style="display:none">
                    <input type="hidden" name="bid" value="{{book.key().id()}}">
                </form>
            </div>
            <div id="addConsignee">
                <h3>Add Consignee</h3>

                <div class="span5">
                Search User
                <form action="/" method="post" class="form-inline">
                    <div class="row">
                    <div class="span"><input type="text" name="user-query" placeholder="Username, Name, or Email"></div>
                    <div class="btn-group span">
                        <a class="btn btn-success dropdown-toggle" data-toggle="dropdown" href="#">Search
                            <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#">Username</a></li>
                        <li><a href="#">Name</a></li>
                        <li><a href="#">Email</a></li>
                    </ul>
                    </div>  
                    </div>
                </form>
                </div>
                <div class="span5">
                <form action="/admin" method="post">
                    <input type="text" placeholder="Username" class="input-medium" id="dis-uname" disabled>
                    <div class="input-prepend">
                        <span class="add-on">Php</span><input type="text" name="ask-price" placeholder="Ask Price" class="input-mini"> 
                    </div>
                    <div class="input-prepend">
                        <span class="add-on">Php</span><input type="text" name="price" placeholder="Sell Price" class="input-mini"> 
                    </div>
                    Rating
                    <br/><input type="submit" id="add-consignee" value="Add Consigned Copy" name="upload-img" class="btn btn-success">
                    <input type="hidden" name="uid">
                    <input type="hidden" name="bid" value="{{book.key().id()}}">
                </form>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Close</a>
        </div>
    </div>
    {% endif %}

{% endblock %}

{% block jscript%}
    $("[id^=stats-]").hide();
    window.sortBy="posted";
    window.offset=0;
    activate('desc');
    document.onload = requestSellers('posted');
    $("#err-container").removeClass();
{% endblock %}

{% macro getDesc(rating) %}
{%if rating==1%}
    We advice that you find other alternatives
{%elif rating==2%}
    Some pages torn<br/>not well maintained
{%elif rating==3%}
    More than 1 year used<br/>Some edges torn
{%elif rating==4%}
    Taken good care<br/>No torn pages/edges<br/>Has never been wet<br/>Well maintained
{%elif rating==5%}
    Brand new quality<br/>Less than 2 months used
{%endif%}
{% endmacro %}

{% macro getDescTitle(rating) %}
{%if rating==1%}
    Abused
{%elif rating==2%}
    Poor
{%elif rating==3%}
    Average
{%elif rating==4%}
    Slightly Used
{%elif rating==5%}
    Good as New
{%endif%}
{% endmacro %}

{% macro adminBookInfo() %}
    <h3><small>Book Information</small></h3>
    <form action="/admin" method="post">
    <table class="table table-bordered table-condensed">
        <tr><td style="width:55px">Title</td>
            <td><span id="xbook-title">{{book.title}}</span>
                <input type="text" id="xinput-title" name="new_title" value="{{book.title}}" placeholder="Title" style="display:none">
            </td></tr>
        <tr><td>Author</td>
            <td><span id="xbook-author">{{book.author}}</span>
                <input type="text" id="xinput-author" name="new_author" value="{{book.author}}" placeholder="Author" style="display:none">
            </td></tr>
        <tr><td>ISBN</td>
            <td><span id="xbook-isbn">{%if book.isbn%}{{book.isbn}}{%else%}No Data{%endif%}</span>
                <input type="text" id="xinput-isbn" name="new_isbn" value="{{book.isbn}}" placeholder="ISBN" style="display:none">
            </td></tr>
        <tr>
            <td>Description</td><td><span id="xbook-desc">{{book.description}}</span>
                <textarea id="xinput-desc" name="new_desc" style="display:none">{{book.desc}}</textarea>
            </td></tr>
    </table>
    <input type="hidden" name="bid" value="{{book.key().id()}}">
    <input id="xinput-submit" type="submit" name="update-info" value="Update Info" class="btn btn-success pull-right" style="display:none">
    </form>
{% endmacro %}